<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RRWeb Debug - Play rrweb recordings</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <!-- Header Navbar -->
    <nav class="navbar navbar-dark bg-dark py-3">
      <div class="container">
        <a href="/" class="navbar-brand mb-0 fw-bold text-decoration-none"
          >RRWeb Debug</a
        >
        <small class="text-muted">Play rrweb recordings in your browser</small>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container col-xl-10 col-xxl-8 px-4 py-5">
      <div class="row align-items-center g-lg-5 py-4">
        <div class="col-lg-7 text-center text-lg-start">
          <h1 class="display-5 fw-bold lh-1 mb-4">Debug Your Recordings</h1>
          <p class="col-lg-10 fs-5 text-muted mb-4">
            Play your rrweb recordings in the browser. Great for debugging and
            sharing your recordings with others.
          </p>

          <div class="card bg-light border-0 mb-4">
            <div class="card-body">
              <h5 class="card-title">How it works</h5>
              <p class="card-text">
                Upload your rrweb events JSON file, paste the content directly,
                or provide a URL to a remote JSON file (like
                <a href="https://jsonblob.com/new" target="_blank"
                  >JSONBlob.com</a
                >
                or Github Gist).
              </p>
            </div>
          </div>
        </div>

        <div class="col-md-10 mx-auto col-lg-5">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="bi bi-upload me-2"></i>Load Your Events
              </h5>
            </div>
            <div class="card-body">
              <form id="eventsForm">
                <!-- Input method selection -->
                <div class="mb-3">
                  <label class="form-label fw-semibold"
                    >Choose input method:</label
                  >
                  <div
                    class="btn-group w-100"
                    role="group"
                    aria-label="Input method"
                  >
                    <input
                      type="radio"
                      class="btn-check"
                      name="inputMethod"
                      id="urlMethod"
                      value="url"
                      checked
                    />
                    <label class="btn btn-outline-primary" for="urlMethod"
                      >URL</label
                    >

                    <input
                      type="radio"
                      class="btn-check"
                      name="inputMethod"
                      id="fileMethod"
                      value="file"
                    />
                    <label class="btn btn-outline-primary" for="fileMethod"
                      >File Upload</label
                    >

                    <input
                      type="radio"
                      class="btn-check"
                      name="inputMethod"
                      id="pasteMethod"
                      value="paste"
                    />
                    <label class="btn btn-outline-primary" for="pasteMethod"
                      >Paste JSON</label
                    >
                  </div>
                </div>

                <!-- URL input -->
                <div id="urlInput" class="input-section mb-3">
                  <label class="form-label fw-semibold">
                    URL of your rrweb events.json file
                  </label>
                  <input
                    class="form-control form-control-lg"
                    type="url"
                    name="url"
                    id="urlField"
                    placeholder="https://gist.githubusercontent.com/Juice10/.../raw/.../events.json"
                  />
                </div>

                <!-- File upload input -->
                <div id="fileInput" class="input-section d-none mb-3">
                  <label class="form-label fw-semibold">
                    Upload your rrweb events JSON file
                  </label>
                  <input
                    class="form-control form-control-lg"
                    type="file"
                    name="file"
                    id="fileField"
                    accept=".json,application/json"
                  />
                </div>

                <!-- Paste JSON input -->
                <div id="pasteInput" class="input-section d-none mb-3">
                  <label class="form-label fw-semibold">
                    Paste your rrweb events JSON content
                  </label>
                  <textarea
                    class="form-control"
                    name="jsonContent"
                    id="jsonField"
                    rows="8"
                    placeholder='[{"type": 0, "data": {...}}, ...]'
                  ></textarea>
                </div>

                <div class="mb-3">
                  <label class="form-label fw-semibold">
                    RRWeb player version
                  </label>
                  <select
                    name="version"
                    id="versions"
                    class="form-select form-select-lg"
                  >
                    <option value="0.7.1">0.7.1 (rrweb v0.9.14)</option>
                    <option value="0.7.2">0.7.2 (rrweb v1.0.0)</option>
                    <option value="0.7.3">0.7.3 (rrweb v1.0.1)</option>
                    <option value="0.7.4">0.7.4 (rrweb v1.0.2)</option>
                    <option value="0.7.5">0.7.5 (rrweb v1.0.3)</option>
                    <option value="0.7.6">0.7.6 (rrweb v1.0.4)</option>
                    <option value="0.7.7">0.7.7 (rrweb v1.0.5)</option>
                    <option value="0.7.8">0.7.8 (rrweb v1.0.6)</option>
                    <option value="0.7.9">0.7.9 (rrweb v1.0.7)</option>
                    <option value="0.7.10">0.7.10 (rrweb v1.0.8)</option>
                    <option value="0.7.11">0.7.11 (rrweb v1.1.0)</option>
                    <option value="0.7.13">0.7.13 (rrweb v1.1.2)</option>
                    <option selected value="0.7.14">
                      0.7.14 (rrweb v1.1.3)
                    </option>
                  </select>
                </div>

                <div class="mb-3">
                  <button
                    class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-between"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#advancedOptions"
                    aria-expanded="false"
                    aria-controls="advancedOptions"
                    id="advancedOptionsBtn"
                  >
                    <span>
                      <i class="bi bi-gear me-2"></i>Advanced Options
                    </span>
                    <i class="bi bi-chevron-down" id="advancedOptionsIcon"></i>
                  </button>
                </div>

                <div class="collapse" id="advancedOptions">
                  <div class="card bg-light border-0 mb-3">
                    <div class="card-body">
                      <div class="form-check form-switch mb-2">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          role="switch"
                          id="canvas-switch"
                          name="canvas"
                        />
                        <label class="form-check-label" for="canvas-switch">
                          Canvas playback
                        </label>
                      </div>
                      <div class="form-check form-switch mb-2">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          role="switch"
                          id="virtual-dom-switch"
                          name="virtual-dom"
                          checked
                        />
                        <label
                          class="form-check-label"
                          for="virtual-dom-switch"
                        >
                          Virtual DOM optimization
                        </label>
                      </div>
                      <div class="form-check form-switch">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          role="switch"
                          id="play-switch"
                          name="play"
                          checked
                        />
                        <label class="form-check-label" for="play-switch">
                          Play immediately
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-grid">
                  <button class="btn btn-primary btn-lg" type="submit">
                    <i class="bi bi-play-circle me-2"></i>Play Recording
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="/src/main.ts"></script>
    <script>
      // Handle input method switching
      function showInputSection() {
        // Hide all input sections
        document.querySelectorAll(".input-section").forEach((section) => {
          section.classList.add("d-none");
        });

        // Show selected input section
        const selectedRadio = document.querySelector(
          'input[name="inputMethod"]:checked',
        );
        if (selectedRadio) {
          const selectedMethod = selectedRadio.value;
          document
            .getElementById(selectedMethod + "Input")
            .classList.remove("d-none");
        }
      }

      // Set up event listeners for radio button changes
      document
        .querySelectorAll('input[name="inputMethod"]')
        .forEach((radio) => {
          radio.addEventListener("change", showInputSection);
        });

      // Show the correct input section on page load (handles browser back navigation)
      // Use pageshow event and setTimeout to ensure browser has restored form state
      window.addEventListener("pageshow", function () {
        setTimeout(showInputSection, 0);
      });

      // Also check on DOMContentLoaded for initial loads
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(showInputSection, 0);
      });

      // Handle form submission
      document
        .getElementById("eventsForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const inputMethod = formData.get("inputMethod");
          const version = formData.get("version");
          const canvas = formData.has("canvas");
          const virtualDom = formData.has("virtual-dom");
          const play = formData.has("play");

          // Build URL parameters
          const params = new URLSearchParams();
          params.set("version", version);
          if (canvas) params.set("canvas", "true");
          if (virtualDom) params.set("virtual-dom", "true");
          if (play) params.set("play", "true");

          if (inputMethod === "url") {
            const url = formData.get("url");
            if (!url) {
              alert("Please enter a URL");
              return;
            }
            params.set("url", url);
          } else {
            let eventsData;

            if (inputMethod === "file") {
              const file = formData.get("file");
              if (!file || file.size === 0) {
                alert("Please select a file");
                return;
              }

              try {
                const text = await file.text();
                eventsData = JSON.parse(text);
              } catch (error) {
                alert("Invalid JSON file: " + error.message);
                return;
              }
            } else if (inputMethod === "paste") {
              const jsonContent = formData.get("jsonContent");
              if (!jsonContent.trim()) {
                alert("Please paste JSON content");
                return;
              }

              try {
                eventsData = JSON.parse(jsonContent);
              } catch (error) {
                alert("Invalid JSON content: " + error.message);
                return;
              }
            }

            // Store events data in sessionStorage
            sessionStorage.setItem("rrweb-events", JSON.stringify(eventsData));
            params.set("source", "local");
          }

          // Navigate to play page
          window.location.href = "play/index.html?" + params.toString();
        });
    </script>
  </body>
</html>
